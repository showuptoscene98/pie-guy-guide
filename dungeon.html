<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Dungeon Overlay</title>
<style>
  html, body { height:100%; }
  body {
    margin:0;
    background:#111;
    color:#fff;
    font-family:Arial, sans-serif;
    overflow:hidden;
  }

  .titlebar {
    height: 64px;
    background: #000;
    display:flex;
    flex-direction:column;
    padding: 8px 10px;
    -webkit-app-region: drag;
    user-select:none;
  }

  .toprow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .dungeon-layout {
    display: flex;
    height: calc(100vh - 64px);
    -webkit-app-region: no-drag;
  }

  .dungeon-sidebar {
    width: 160px;
    flex-shrink: 0;
    background: #0a0a0a;
    border-right: 1px solid rgba(255,255,255,0.08);
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .dungeon-sidebar label {
    font-size: 11px;
    color: rgba(255,255,255,0.8);
    display: block;
    margin-bottom: 4px;
  }

  .dungeon-sidebar select {
    width: 100%;
    padding: 6px 8px;
    font-size: 12px;
    background: #222;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
  }

  .dungeon-sidebar select:focus {
    outline: none;
    border-color: rgba(255,204,77,0.5);
  }

  .dungeon-opacity-wrap {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .dungeon-opacity-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .dungeon-opacity-value {
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    min-width: 32px;
    text-align: right;
  }

  .dungeon-opacity-slider {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
  }

  .dungeon-opacity-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #ffcc4d;
    cursor: pointer;
    border: none;
  }

  .dungeon-opacity-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #ffcc4d;
    cursor: pointer;
    border: none;
  }

  .btn {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    background: #222;
    color: #fff;
    cursor: pointer;
  }
  .btn:hover { background: #333; }

  .stage-wrap {
    flex: 1;
    min-width: 0;
    position: relative;
  }

  .stage {
    width: 100%;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    touch-action: none;
    background:
      radial-gradient(800px 500px at 20% 10%, rgba(255,204,77,0.08), transparent 55%),
      radial-gradient(800px 500px at 80% 20%, rgba(90,120,255,0.10), transparent 60%),
      #111;
  }

  .canvas {
    position:absolute;
    left:0;
    top:0;
    transform-origin:0 0;
    cursor:grab;
  }
  .canvas.dragging { cursor:grabbing; }

  img {
    display:block;
    max-width:none;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }

  .hint{
    font-size:12px;
    color:rgba(255,255,255,0.70);
    margin-top:2px;
  }

  .clickthrough-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    -webkit-app-region: no-drag;
  }
  .clickthrough-wrap label {
    font-size: 12px;
    cursor: pointer;
    user-select: none;
  }
</style>
</head>
<body tabindex="0">

<div class="titlebar">
  <div class="toprow">
    <div>
      <div style="font-weight:900;">Dungeons</div>
      <div class="hint">Drag to pan • Mouse wheel zooms • ESC closes • F8 click-through</div>
    </div>
    <div class="clickthrough-wrap">
      <input type="checkbox" id="clickthroughCheck" />
      <label for="clickthroughCheck">Click-through</label>
    </div>
    <button class="btn" style="-webkit-app-region:no-drag;" onclick="window.api.closeOverlay()">Close</button>
  </div>
</div>

<div class="dungeon-layout">
  <aside class="dungeon-sidebar">
    <div>
      <label for="dungeonSelect">Dungeon</label>
      <select id="dungeonSelect" aria-label="Select dungeon"></select>
    </div>
    <div class="dungeon-opacity-wrap">
      <label for="dungeonOpacitySlider">Opacity</label>
      <div class="dungeon-opacity-row">
        <input type="range" id="dungeonOpacitySlider" class="dungeon-opacity-slider" min="30" max="100" value="100" />
        <span class="dungeon-opacity-value" id="dungeonOpacityValue">100%</span>
      </div>
    </div>
  </aside>
  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="canvas" id="canvas">
        <img id="dungeonImage" src="" draggable="false" alt="Dungeon" />
      </div>
    </div>
  </div>
</div>

<script>
  window.addEventListener("contextmenu", (e) => e.preventDefault());
  window.addEventListener("dragstart", (e) => e.preventDefault());

  function forceFocus(){
    document.body.focus();
    window.focus();
  }
  window.addEventListener("load", forceFocus);
  window.addEventListener("focus", forceFocus);
  document.addEventListener("mousedown", forceFocus);

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") window.api.closeOverlay();
  });

  // Click-through option (F8 toggles when overlay can't be clicked)
  const clickthroughCheck = document.getElementById("clickthroughCheck");
  if (clickthroughCheck && window.api) {
    clickthroughCheck.addEventListener("change", () => {
      window.api.setOverlayClickthrough(clickthroughCheck.checked);
    });
    window.api.onOverlayClickthroughState?.((value) => {
      clickthroughCheck.checked = !!value;
    });
  }

  const dungeons = [
    "Goblin Dungeon Lower",
    "Goblin Dungeon Upper",
    "Kur Tower",
    "Rahu Sewer",
    "Serbule Crypt",
    "Wolf Cave",
    "Yeti Cave",
    "Myconian Cave"
  ];

  const DUNGEON_SIDEBAR_WIDTH = 160;

  const dungeonSelect = document.getElementById("dungeonSelect");
  const dungeonImage = document.getElementById("dungeonImage");
  const stage = document.getElementById("stage");
  const canvas = document.getElementById("canvas");
  const dungeonOpacitySlider = document.getElementById("dungeonOpacitySlider");
  const dungeonOpacityValue = document.getElementById("dungeonOpacityValue");

  let scale = 0.8;
  let x = 40;
  let y = 40;

  function applyTransform(){
    canvas.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
  }

  function loadDungeon(name){
    dungeonImage.onload = function(){
      if (window.api && window.api.setOverlaySize && dungeonImage.naturalWidth && dungeonImage.naturalHeight) {
        window.api.setOverlaySize(DUNGEON_SIDEBAR_WIDTH + dungeonImage.naturalWidth, dungeonImage.naturalHeight);
      }
    };
    dungeonImage.src = `dungeons/${name}.jpg`;
    scale = 0.8; x = 40; y = 40;
    applyTransform();
  }

  dungeons.forEach((name) => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    dungeonSelect.appendChild(opt);
  });

  dungeonSelect.addEventListener("change", () => loadDungeon(dungeonSelect.value));

  if (dungeonOpacitySlider && window.api && window.api.setOverlayOpacity) {
    dungeonOpacitySlider.addEventListener("input", () => {
      const pct = dungeonOpacitySlider.value;
      if (dungeonOpacityValue) dungeonOpacityValue.textContent = pct + "%";
      window.api.setOverlayOpacity(Number(pct) / 100);
    });
  }

  loadDungeon(dungeons[0]);
  dungeonSelect.value = dungeons[0];

  // Pan
  let dragging = false;
  let start = { px:0, py:0, x:0, y:0 };

  stage.addEventListener("pointerdown", (e) => {
    dragging = true;
    stage.setPointerCapture(e.pointerId);
    start = { px: e.clientX, py: e.clientY, x, y };
    canvas.classList.add("dragging");
  });

  stage.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    x = start.x + (e.clientX - start.px);
    y = start.y + (e.clientY - start.py);
    applyTransform();
  });

  stage.addEventListener("pointerup", () => {
    dragging = false;
    canvas.classList.remove("dragging");
  });
  stage.addEventListener("pointercancel", () => {
    dragging = false;
    canvas.classList.remove("dragging");
  });

  // Zoom at cursor
  stage.addEventListener("wheel", (e) => {
    e.preventDefault();

    const rect = stage.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const wx = (mx - x) / scale;
    const wy = (my - y) / scale;

    const zoomIntensity = 0.0015;
    const next = clamp(scale * (1 + (-e.deltaY * zoomIntensity)), 0.2, 3.5);

    x = mx - wx * next;
    y = my - wy * next;
    scale = next;

    applyTransform();
  }, { passive:false });

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
</script>

</body>
</html>
