<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Map Overlay</title>
<style>
  html, body { height:100%; }
  body {
    margin:0;
    background:#111;
    color:#fff;
    font-family:Arial, sans-serif;
    overflow:hidden;
  }

  .titlebar {
    height: 64px;
    background: #000;
    display:flex;
    flex-direction:column;
    padding: 8px 10px;
    -webkit-app-region: drag;
    user-select:none;
  }

  .toprow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .buttons {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:6px;
    -webkit-app-region: no-drag;
  }

  .btn {
    padding:4px 8px;
    font-size:11px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.2);
    background:#222;
    color:#fff;
    cursor:pointer;
  }
  .btn:hover { background:#333; }

  .stage {
    width:100vw;
    height:calc(100vh - 64px);
    overflow:hidden;
    position:relative;
    touch-action:none; /* IMPORTANT: stops browser gestures from interfering */
    background:
      radial-gradient(800px 500px at 20% 10%, rgba(255,204,77,0.08), transparent 55%),
      radial-gradient(800px 500px at 80% 20%, rgba(90,120,255,0.10), transparent 60%),
      #111;
  }

  .canvas {
    position:absolute;
    left:0;
    top:0;
    transform-origin:0 0;
    cursor:grab;
  }
  .canvas.dragging { cursor:grabbing; }

  img {
    display:block;
    max-width:none; /* allow zooming bigger than viewport */
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none; /* IMPORTANT: stage gets all input */
  }

  .hint{
    font-size:12px;
    color:rgba(255,255,255,0.70);
    margin-top:2px;
  }

  .clickthrough-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    -webkit-app-region: no-drag;
  }
  .clickthrough-wrap label {
    font-size: 12px;
    cursor: pointer;
    user-select: none;
  }
</style>
</head>
<body tabindex="0">

<div class="titlebar">
  <div class="toprow">
    <div>
      <div style="font-weight:900;">Maps</div>
      <div class="hint">Drag to pan • Mouse wheel zooms • ESC closes • F8 click-through</div>
    </div>
    <div class="clickthrough-wrap">
      <input type="checkbox" id="clickthroughCheck" />
      <label for="clickthroughCheck">Click-through</label>
    </div>
    <button class="btn" style="-webkit-app-region:no-drag;" onclick="window.api.closeOverlay()">Close</button>
  </div>
  <div class="buttons" id="mapButtons"></div>
</div>

<div class="stage" id="stage">
  <div class="canvas" id="canvas">
    <img id="mapImage" src="" draggable="false" alt="Map" />
  </div>
</div>

<script>
  // Hard-disable right click + drag-out
  window.addEventListener("contextmenu", (e) => e.preventDefault());
  window.addEventListener("dragstart", (e) => e.preventDefault());

  // Ensure keyboard focus so ESC always works
  function forceFocus(){
    document.body.focus();
    window.focus();
  }
  window.addEventListener("load", forceFocus);
  window.addEventListener("focus", forceFocus);
  document.addEventListener("mousedown", forceFocus);

  // ESC close (use window keydown for reliability)
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") window.api.closeOverlay();
  });

  // Click-through option (F8 toggles when overlay can't be clicked)
  const clickthroughCheck = document.getElementById("clickthroughCheck");
  if (clickthroughCheck && window.api) {
    clickthroughCheck.addEventListener("change", () => {
      window.api.setOverlayClickthrough(clickthroughCheck.checked);
    });
    window.api.onOverlayClickthroughState?.((value) => {
      clickthroughCheck.checked = !!value;
    });
  }

  const maps = [
    "AnagogeIsland",
    "Eltibule",
    "Fae Realm",
    "Gazluk",
    "Ilmari",
    "Kur Mountains",
    "Povus",
    "Rahu",
    "Serbule",
    "SerbuleHills",
    "Sun Vale"
  ];

  const mapButtons = document.getElementById("mapButtons");
  const mapImage = document.getElementById("mapImage");
  const stage = document.getElementById("stage");
  const canvas = document.getElementById("canvas");

  let scale = 0.8;
  let x = 40;
  let y = 40;

  function applyTransform(){
    canvas.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
  }

  function loadMap(name){
    mapImage.src = `maps/${name}.jpg`;
    // Reset view on load
    scale = 0.8; x = 40; y = 40;
    applyTransform();
  }

  // Build map buttons
  maps.forEach((name) => {
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = name;
    btn.addEventListener("click", () => loadMap(name));
    mapButtons.appendChild(btn);
  });

  // Load first map
  loadMap(maps[0]);

  // ===== PAN (pointer events = reliable) =====
  let dragging = false;
  let start = { px:0, py:0, x:0, y:0 };

  stage.addEventListener("pointerdown", (e) => {
    // Only left mouse / primary pointer
    dragging = true;
    stage.setPointerCapture(e.pointerId);
    start = { px: e.clientX, py: e.clientY, x, y };
    canvas.classList.add("dragging");
  });

  stage.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    x = start.x + (e.clientX - start.px);
    y = start.y + (e.clientY - start.py);
    applyTransform();
  });

  stage.addEventListener("pointerup", () => {
    dragging = false;
    canvas.classList.remove("dragging");
  });
  stage.addEventListener("pointercancel", () => {
    dragging = false;
    canvas.classList.remove("dragging");
  });

  // ===== MOUSE-CENTERED ZOOM =====
  stage.addEventListener("wheel", (e) => {
    e.preventDefault();

    const rect = stage.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    // world coords under cursor pre-zoom
    const wx = (mx - x) / scale;
    const wy = (my - y) / scale;

    const zoomIntensity = 0.0015;
    const next = clamp(scale * (1 + (-e.deltaY * zoomIntensity)), 0.2, 3.5);

    // keep world point under cursor fixed
    x = mx - wx * next;
    y = my - wy * next;
    scale = next;

    applyTransform();
  }, { passive:false });

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
</script>

</body>
</html>
